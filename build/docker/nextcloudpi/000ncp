#!/usr/bin/env bash

source /usr/local/etc/library.sh

# INIT NCP CONFIG (first run)
[[ "$1" == "start" ]] && [[ -d /data/ncp ]] && {
  echo "Install default configurations for new ncp apps"
  rsync --ignore-existing -a --out-format="%n" /usr/local/etc/ncp-config.d/*.cfg /data/ncp/ | awk '{ print " > " $0 }'
}
persistConfiguration /usr/local/etc/ncp-config.d /data/ncp
persistConfiguration /etc/letsencrypt                    # persist SSL certificates
persistConfiguration /etc/shadow                         # persist ncp-web password
persistConfiguration /etc/cron.d
persistConfiguration /etc/cron.daily
persistConfiguration /etc/cron.hourly
persistConfiguration /etc/cron.weekly

# reset bin if we pull a more recent container
[[ -d /data/bin ]] && {
  date_img=$(date "+%s" -r /.docker-image)
  date_per=$(date "+%s" -r /data/bin)
  [[ $date_img -gt $date_per ]] && {
    rm -r /data/bin
  }
}
persistConfiguration /usr/local/bin /data/bin

[[ "$1" == "start" ]] && {
  installTemplate "php/opcache.ini.sh" "/etc/php/${PHPVER}/mods-available/opcache.ini"
  installTemplate "php/90-ncp.ini.sh" "/etc/php/${PHPVER}/fpm/conf.d/90-ncp.ini"
  installTemplate "php/pool.d.www.conf.sh" "/etc/php/${PHPVER}/fpm/pool.d/www.conf"
  #installTemplate "mysql/91-ncp.cnf.sh" "/etc/mysql/mariadb.conf.d/91-ncp.cnf"
  installTemplate "ncp-metrics.cfg.sh" "/usr/local/etc/ncp-metrics.cfg"
}

touch /var/log/ncp.log
tail -f -n0 "/var/log/ncp.log" &

exit 0
