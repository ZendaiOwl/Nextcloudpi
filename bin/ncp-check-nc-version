#!/usr/bin/env bash

# notify latest available NC version

set -e

source /usr/local/etc/library.sh # sets NCLATESTVER

CURRENT="$(ncc status | grep "version:" | awk '{ print $3 }')"
LATEST="$(wget -qO- https://raw.githubusercontent.com/nextcloud/nextcloudpi/master/etc/ncp.cfg | jq -r .nextcloud_version)"
NOTIFIED=/var/run/.nc-version-notified

test -e "${NOTIFIED}" && [[ "${LATEST}" == "$( cat "${NOTIFIED}" )" ]] && {
  echo "Found update from ${CURRENT} to ${LATEST}. Already notified"
  exit 0
}

if isMoreRecent "${LATEST}" "${CURRENT}"; then
  notifyAdmin \
    "Nextcloud update" \
    "Update from ${CURRENT} to ${LATEST} is available. Update from https://$(getIP):4443"
  echo "${LATEST}" > "${NOTIFIED}"
fi
